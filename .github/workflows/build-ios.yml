name: Build iOS IPA

on:
  push:  
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:  
        xcode-version:  latest-stable
    
    - name: Import Certificate
      env:
        P12_CERTIFICATE: ${{ secrets.P12_CERTIFICATE }}
        P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
      run: |
        # åˆ›å»ºä¸´æ—¶ keychain
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
        KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
        
        # åˆ›å»º keychain
        security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
        security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
        
        # å¯¼å…¥è¯ä¹¦
        CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
        echo -n "$P12_CERTIFICATE" | base64 --decode -o "$CERTIFICATE_PATH"
        security import "$CERTIFICATE_PATH" -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
        security list-keychain -d user -s "$KEYCHAIN_PATH"
        security set-key-partition-list -S apple-tool:,apple:  -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
    
    - name: Import Provisioning Profile
      env:  
        MOBILEPROVISION: ${{ secrets. MOBILEPROVISION }}
      run: |
        # åˆ›å»º provisioning profile ç›®å½•
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        
        # å¯¼å…¥æè¿°æ–‡ä»¶
        PROVISION_PATH=$RUNNER_TEMP/profile.mobileprovision
        echo -n "$MOBILEPROVISION" | base64 --decode -o "$PROVISION_PATH"
        
        # è·å– UUID å¹¶å¤åˆ¶åˆ°æ­£ç¡®ä½ç½®
        UUID=$(/usr/libexec/PlistBuddy -c "Print :UUID" /dev/stdin <<< $(security cms -D -i "$PROVISION_PATH"))
        cp "$PROVISION_PATH" ~/Library/MobileDevice/Provisioning\ Profiles/${UUID}.mobileprovision
    
    - name: Build Archive
      run: |
        xcodebuild -project CameraAccess.xcodeproj \
          -scheme TurboMeta \
          -configuration Release \
          -archivePath $RUNNER_TEMP/TurboMeta.xcarchive \
          archive \
          CODE_SIGN_STYLE=Manual \
          DEVELOPMENT_TEAM=XHTH2G7Q5Y
    
    - name: Export IPA
      run: |
        # åˆ›å»º ExportOptions. plist
        cat > $RUNNER_TEMP/ExportOptions.plist <<EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
          <key>method</key>
          <string>ad-hoc</string>
          <key>teamID</key>
          <string>XHTH2G7Q5Y</string>
          <key>signingStyle</key>
          <string>manual</string>
          <key>compileBitcode</key>
          <false/>
          <key>stripSwiftSymbols</key>
          <true/>
        </dict>
        </plist>
        EOF
        
        xcodebuild -exportArchive \
          -archivePath $RUNNER_TEMP/TurboMeta.xcarchive \
          -exportPath $RUNNER_TEMP/export \
          -exportOptionsPlist $RUNNER_TEMP/ExportOptions.plist
    
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name:  TurboMeta-IPA
        path: ${{ runner.temp }}/export/*. ipa
        retention-days: 30
    
    - name: Display Download Instructions
      run: |
        echo "âœ… IPA æ„å»ºæˆåŠŸï¼"
        echo "ğŸ“± ä¸‹è½½æ–¹æ³•ï¼š"
        echo "1. è¿›å…¥ GitHub Actions é¡µé¢"
        echo "2. ç‚¹å‡»è¿™æ¬¡è¿è¡Œçš„å·¥ä½œæµ"
        echo "3. åœ¨é¡µé¢åº•éƒ¨çš„ Artifacts åŒºåŸŸä¸‹è½½ TurboMeta-IPA"
        echo "4. è§£å‹åä½¿ç”¨ iTunesã€Xcode æˆ–å…¶ä»–å·¥å…·å®‰è£…åˆ°æ‚¨çš„ iPhone"
