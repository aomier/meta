name: Build iOS IPA

on: 
  push:
    branches:  [main]
  workflow_dispatch: 

jobs:
  build: 
    runs-on:  macos-latest
    
    steps: 
    - name:  Checkout repository
      uses: actions/checkout@v4
    
    - name:  Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:  
        xcode-version:  latest-stable
    
    - name: Import Certificate
      env:  
        P12_CERTIFICATE: ${{ secrets.P12_CERTIFICATE }}
        P12_PASSWORD:  ${{ secrets.P12_PASSWORD }}
      run: |
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing. keychain-db
        KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
        
        security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
        security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
        
        CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
        echo "$P12_CERTIFICATE" | base64 -d > "$CERTIFICATE_PATH"
        
        security import "$CERTIFICATE_PATH" -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
        security list-keychain -d user -s "$KEYCHAIN_PATH"
        security set-key-partition-list -S apple-tool:,apple:  -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
        
        echo "ËØÅ‰π¶ÂØºÂÖ•ÊàêÂäüÔºåÂàóÂá∫ÊâÄÊúâË∫´‰ªΩÔºö"
        security find-identity -v -p codesigning "$KEYCHAIN_PATH"
    
    - name: Import Provisioning Profile
      env:
        MOBILEPROVISION: ${{ secrets.MOBILEPROVISION }}
      run: |
        PP_PATH="$HOME/Library/MobileDevice/Provisioning Profiles"
        mkdir -p "$PP_PATH"
        
        PROVISION_PATH=$RUNNER_TEMP/profile.mobileprovision
        echo "$MOBILEPROVISION" | base64 -d > "$PROVISION_PATH"
        
        UUID=$(security cms -D -i "$PROVISION_PATH" | plutil -extract UUID raw -)
        echo "Provisioning Profile UUID:  $UUID"
        
        cp "$PROVISION_PATH" "$PP_PATH/$UUID.mobileprovision"
        
        echo "ÊèèËø∞Êñá‰ª∂‰ø°ÊÅØÔºö"
        security cms -D -i "$PROVISION_PATH" | plutil -p -
    
    - name: Build Archive
      run: |
        # Ëé∑ÂèñËØÅ‰π¶Ë∫´‰ªΩ
        IDENTITY=$(security find-identity -v -p codesigning $RUNNER_TEMP/app-signing.keychain-db | grep "iPhone" | head -1 | grep -o '"[^"]*"' | tr -d '"')
        echo "‰ΩøÁî®ËØÅ‰π¶Ë∫´‰ªΩ: $IDENTITY"
        
        xcodebuild -project CameraAccess.xcodeproj \
          -scheme TurboMeta \
          -configuration Release \
          -archivePath $RUNNER_TEMP/TurboMeta.xcarchive \
          -destination 'generic/platform=iOS' \
          archive \
          CODE_SIGN_IDENTITY="$IDENTITY" \
          CODE_SIGN_STYLE=Manual \
          DEVELOPMENT_TEAM=XHTH2G7Q5Y \
          PRODUCT_BUNDLE_IDENTIFIER=tg.tgquS476.tool7 \
          PROVISIONING_PROFILE="8a6baa6e-e182-4230-81d0-4d4ad08bb063" \
          | tee build. log
        
        if [ ${PIPESTATUS[0]} -ne 0 ]; then
          echo "ÊûÑÂª∫Â§±Ë¥•ÔºåÊü•ÁúãËØ¶ÁªÜÊó•Âøó"
          cat build. log
          exit 1
        fi
    
    - name:  Export IPA
      run: |
        IDENTITY=$(security find-identity -v -p codesigning $RUNNER_TEMP/app-signing.keychain-db | grep "iPhone" | head -1 | grep -o '"[^"]*"' | tr -d '"')
        
        cat > $RUNNER_TEMP/ExportOptions.plist <<EOF
        <? xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
          <key>method</key>
          <string>development</string>
          <key>teamID</key>
          <string>XHTH2G7Q5Y</string>
          <key>signingCertificate</key>
          <string>${IDENTITY}</string>
          <key>signingStyle</key>
          <string>manual</string>
          <key>provisioningProfiles</key>
          <dict>
            <key>tg.tgquS476.tool7</key>
            <string>8a6baa6e-e182-4230-81d0-4d4ad08bb063</string>
          </dict>
        </dict>
        </plist>
        EOF
        
        cat $RUNNER_TEMP/ExportOptions.plist
        
        xcodebuild -exportArchive \
          -archivePath $RUNNER_TEMP/TurboMeta.xcarchive \
          -exportPath $RUNNER_TEMP/export \
          -exportOptionsPlist $RUNNER_TEMP/ExportOptions. plist
    
    - name: Upload IPA
      uses:  actions/upload-artifact@v4
      with: 
        name: TurboMeta-IPA
        path:  ${{ runner.temp }}/export/*.ipa
        retention-days: 30
    
    - name: Display Download Instructions
      run: |
        echo "‚úÖ IPA ÊûÑÂª∫ÊàêÂäüÔºÅ"
        echo "üì± ‰∏ãËΩΩÂú∞ÂùÄ: https://github.com/aomier/meta/actions"
